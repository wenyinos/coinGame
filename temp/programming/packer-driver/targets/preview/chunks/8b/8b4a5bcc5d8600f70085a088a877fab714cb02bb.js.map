{"version":3,"sources":["file:///D:/MyCoding/Cosos/coinGame/assets/scripts/frame/input/JoystickCtrl.ts"],"names":["_decorator","Component","Node","Vec3","Vec2","UIOpacity","tween","Quat","ctrl","ccclass","property","_tempVec3","_tempVec2","_tempQuat","rad","Math","PI","JoystickCtrl","type","distance","startPos","jumpBtn","arrowOp","start","init","joyStick","getPosition","onEnable","touchArea","on","EventType","TOUCH_START","touchStart","TOUCH_MOVE","touchMove","TOUCH_END","touchEnd","TOUCH_CANCEL","indexArrow","getComponent","addComponent","jump","opacity","onDisable","off","touch","active","joystick","to","setWorldPosition","getUILocation","x","y","getWorldPosition","lengthSqr","min","maxRadius","normalize","mag","h","v","multiplyScalar","euler","atan2","rotation","fromAngleZ","control","setPosition","ZERO"],"mappings":"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","sourcesContent":["\r\nimport { _decorator, Component, Node, Vec3, Vec2, UIOpacity, tween, Touch, Quat } from 'cc';\r\nimport ctrl from './InputCtrl';\r\n\r\nconst { ccclass, property } = _decorator;\r\n\r\nconst _tempVec3 = new Vec3();\r\nconst _tempVec2 = new Vec2();\r\nconst _tempQuat = new Quat();\r\nconst rad = Math.PI/180;\r\n\r\n@ccclass('JoystickCtrl')\r\nexport class JoystickCtrl extends Component {\r\n\r\n    @property\r\n    maxRadius = 60;\r\n\r\n    @property({ type: Node })\r\n    touchArea: Node | null = null;\r\n\r\n    @property({ type: Node })\r\n    control: Node | null = null;\r\n\r\n    @property({ type: Node })\r\n    indexArrow: Node = null!;\r\n\r\n    @property({ type: Node })\r\n    joyStick: Node = null!;\r\n\r\n    distance: number = 0;\r\n\r\n    private startPos = new Vec3();\r\n    jumpBtn: Node = null!;\r\n\r\n    arrowOp: UIOpacity = null;\r\n\r\n\r\n    start() {\r\n        this.init();\r\n    }\r\n\r\n    init() {\r\n        this.joyStick.getPosition(this.startPos);\r\n    }\r\n\r\n    onEnable() {\r\n        this.touchArea.on(Node.EventType.TOUCH_START, this.touchStart, this);\r\n        this.touchArea.on(Node.EventType.TOUCH_MOVE, this.touchMove, this);\r\n        this.touchArea.on(Node.EventType.TOUCH_END, this.touchEnd, this);\r\n        this.touchArea.on(Node.EventType.TOUCH_CANCEL, this.touchEnd, this);\r\n        this.arrowOp = this.indexArrow.getComponent(UIOpacity);\r\n        if(!this.arrowOp){\r\n            this.arrowOp = this.indexArrow.addComponent(UIOpacity);\r\n        }\r\n        this.jumpBtn && this.jumpBtn.on(Node.EventType.TOUCH_END, this.jump, this);\r\n        this.arrowOp.opacity = 0;\r\n    }\r\n\r\n    onDisable() {\r\n        this.touchArea.off(Node.EventType.TOUCH_START, this.touchStart, this);\r\n        this.touchArea.off(Node.EventType.TOUCH_MOVE, this.touchMove, this);\r\n        this.touchArea.off(Node.EventType.TOUCH_END, this.touchEnd, this);\r\n        this.touchArea.off(Node.EventType.TOUCH_CANCEL, this.touchEnd, this);\r\n        this.jumpBtn && this.jumpBtn.off(Node.EventType.TOUCH_END, this.jump, this);\r\n    }\r\n\r\n\r\n    touchStart(touch: Touch) {\r\n        if (!this.joyStick.active) return;\r\n        ctrl.joystick = true;\r\n        tween(this.arrowOp).to(0.5, { opacity: 255 }).start();\r\n        this.joyStick.setWorldPosition(touch.getUILocation().x, touch.getUILocation().y, 0);\r\n    }\r\n\r\n    touchMove(touch: Touch) {\r\n        if (!this.joyStick.active) return;\r\n        touch.getUILocation(_tempVec2);\r\n        this.joyStick.getWorldPosition(_tempVec3);\r\n        _tempVec2.x -= _tempVec3.x, _tempVec2.y -= _tempVec3.y;\r\n        this.distance = _tempVec2.lengthSqr();\r\n        this.distance = Math.min(this.distance,this.maxRadius);\r\n        _tempVec2.normalize();\r\n        ctrl.mag = (this.distance / this.maxRadius) * 1.2;\r\n        ctrl.h = _tempVec2.y, ctrl.v = _tempVec2.x;\r\n        _tempVec2.multiplyScalar(this.distance);\r\n        const euler = -Math.atan2(_tempVec2.x, _tempVec2.y) / rad;\r\n        this.indexArrow.rotation = Quat.fromAngleZ(_tempQuat,euler);\r\n        this.control.setPosition(_tempVec2.x, _tempVec2.y);\r\n    }\r\n\r\n    jump() {\r\n        ctrl.jump = true;\r\n    }\r\n\r\n    touchEnd() {\r\n        if (!this.joyStick.active) return;\r\n        ctrl.joystick = false;\r\n        tween(this.arrowOp).to(0.6, { opacity: 0 }).start();\r\n        ctrl.mag = 1;\r\n        ctrl.h = 0;\r\n        ctrl.v = 0;\r\n        this.control.setPosition(Vec3.ZERO);\r\n        this.joyStick.setPosition(this.startPos);\r\n    }\r\n\r\n}"]}