{"version":3,"sources":["file:///D:/MyCoding/Cosos/coinGame/assets/scripts/coin/CoinMgr.ts"],"names":["_decorator","Component","Layers","tween","Vec3","aa","ui","CoinBarView","PlayerCtrl","CoinView","ccclass","property","temp_V3_1","temp_V3_2","temp_V3_3","coinScaled","CoinMgr","_time","_interval","_coins","_coinView","_coinViewComp","_coinBarView","_coinBarViewComp","_currentCoins","_playerPos","start","res","getUI","getComponent","spawnCoins","dt","createCoin","Math","random","layer3D","children","length","floor","x","z","coin","getNode","set","setScale","setRotationFromEuler","layer","Enum","DEFAULT","collectCoins","backCoins","bl","t","min","global","player","wave","cameras","worldToScreen","worldPosition","flyingPos","screenToWorld","addCoin","i","parent","UI_3D","delay","to","position","scale","easing","call","putNode","updateCoinBar","copy","y","convertToUINode","layer2D","checkCoins","coins","dis","utils","getMdisXZ","moveCoins","isMove","max","lerp","update"],"mappings":"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","sourcesContent":["import { _decorator, Component, easing, Layers, Node, tween, UI, Vec3 } from 'cc';\r\nimport { aa } from '../frame/FrameCore';\r\nimport { ui } from '../frame/Enums';\r\nimport { CoinBarView } from '../view/CoinBarView';\r\nimport { PlayerCtrl } from '../combat/ctrl/PlayerCtrl';\r\nimport { CoinView } from '../view/CoinView';\r\nconst { ccclass, property } = _decorator;\r\nconst temp_V3_1 = new Vec3();\r\nconst temp_V3_2 = new Vec3();\r\nconst temp_V3_3 = new Vec3();\r\nconst coinScaled = new Vec3(4.8, 4.8, 4.8);\r\n\r\n@ccclass('CoinMgr')\r\nexport class CoinMgr extends Component {\r\n\r\n    _time = 0;\r\n    _interval = 3;\r\n    /* start coins */\r\n    _coins = 50;\r\n    _coinView: Node;\r\n    _coinViewComp: CoinView;\r\n    _coinBarView: Node;\r\n    _coinBarViewComp: CoinBarView;\r\n    _currentCoins = 0;\r\n    _playerPos =new Vec3();\r\n\r\n    async start() {\r\n        this._coinView = await aa.res.getUI(ui.CoinView);\r\n        this._coinViewComp = this._coinView.getComponent(CoinView);\r\n        this._coinBarView = await aa.res.getUI(ui.CoinBarView);\r\n        this._coinBarViewComp = this._coinBarView.getComponent(CoinBarView);\r\n\r\n    }\r\n    spawnCoins(dt) {\r\n        if (this._coins > 0) {\r\n            this._coins--;\r\n            this.createCoin();\r\n        }\r\n        this._time += dt;\r\n        if (this._time > this._interval) {\r\n            this._time = 0;\r\n            /* random coins */\r\n            this._interval = 3 + 2 * Math.random();\r\n            if (aa.layer3D[2].children.length < 75) {\r\n                this._coins += Math.floor(6 + 6 * Math.random());\r\n            }\r\n        }\r\n    }\r\n    \r\n\r\n    createCoin() {\r\n        const x = -20 + Math.random() * 40;\r\n        const z = -20 + Math.random() * 40;\r\n        const coin = aa.res.getNode(\"Coin\", aa.layer3D[2], Vec3.set(temp_V3_2, x, 0.5, z));\r\n        coin.setScale(0.5, 0.5, 0.5);\r\n        coin.setRotationFromEuler(90, 0, 0);\r\n        coin.layer = Layers.Enum.DEFAULT;\r\n    }\r\n    collectCoins(dt, backCoins: Node[]) {\r\n        const bl = backCoins.length;\r\n        const t = Math.min(1,0.2+bl*0.02);\r\n        aa.global.player.getComponent(PlayerCtrl).wave(t);\r\n        /* 2D UI Node's wordposition to screen space pos*/\r\n        aa.cameras[1].worldToScreen(this._coinView.worldPosition, temp_V3_3);\r\n        const flyingPos = new Vec3();\r\n        /* screen space pos to  3d world position under this camera*/\r\n        aa.cameras[0].screenToWorld(temp_V3_3, flyingPos);\r\n        this._coinViewComp.addCoin(bl);\r\n        for (var i = bl - 1; i >= 0; i--) {\r\n            const coin = backCoins[i];\r\n            /* change layer */\r\n            coin.parent = aa.layer3D[4];\r\n            coin.layer = Layers.Enum.UI_3D;\r\n            coin.setRotationFromEuler(90, 0, 0)\r\n            const delay = i * dt;\r\n            /* move and scale the coin */\r\n            tween(coin).delay(delay).to(0.5 + delay, { position: flyingPos, scale: coinScaled }, { easing: 'fade' }).call(() => {\r\n                aa.res.putNode(coin);\r\n            }).start();\r\n        }\r\n    }\r\n    updateCoinBar(backCoins: Node[]) {\r\n        if (this._coinBarViewComp) {\r\n            /* backcoins length */\r\n            const bl = backCoins.length;\r\n            Vec3.copy(temp_V3_1, this._playerPos);\r\n            temp_V3_1.y += 1.5 + (bl + 1) * 0.075;\r\n            aa.cameras[0].convertToUINode(temp_V3_1, aa.layer2D[4], temp_V3_1);\r\n            this._coinBarView.position = temp_V3_1;\r\n            if (this._currentCoins != bl) {\r\n                this._currentCoins = bl;\r\n                this._coinBarViewComp.coin = \"Coins \" + bl;\r\n            }\r\n        }\r\n    }\r\n    checkCoins() {\r\n        const coins = aa.layer3D[2].children;\r\n        const parent = aa.layer3D[3];\r\n        const length = coins.length;\r\n        for (var i = length - 1; i >= 0; i--) {\r\n            const coin = coins[i];\r\n            /* we use manhattanDis for better perf */\r\n            const dis = aa.utils.getMdisXZ(coin.position, this._playerPos)\r\n            if (dis < 0.5) {\r\n                coin.parent = parent;\r\n                coin.setRotationFromEuler(0, 0, 0)\r\n            }\r\n        }\r\n    }\r\n    moveCoins(dt, backCoins: Node[]){\r\n        let bl = backCoins.length;\r\n        /* coin move logic */\r\n        if (!aa.global.isMove && bl > 0) {\r\n            this.collectCoins(dt, backCoins);\r\n        } else {\r\n            if (bl >= 50) {\r\n                this.collectCoins(dt, backCoins);\r\n            } else {\r\n                for (var i = bl - 1; i >= 0; i--) {\r\n                    const coin = backCoins[i];\r\n                    Vec3.copy(temp_V3_1, this._playerPos);\r\n                    temp_V3_1.y += 1.4 + (bl - i) * 0.075;\r\n                    const t = dt * (Math.max(1, (19 - (bl - i) * 0.35)));\r\n                    coin.position = Vec3.lerp(temp_V3_2, coin.position, temp_V3_1, t);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    update(dt: number) {\r\n        /* store player's pos */\r\n        Vec3.copy(this._playerPos, aa.global.player.position);\r\n\r\n        /* coin spawn logic */\r\n        this.spawnCoins(dt);\r\n\r\n        const backCoins =  aa.layer3D[3].children;\r\n        this.moveCoins(dt, backCoins);\r\n   \r\n        /* coins check logic */\r\n        this.checkCoins();\r\n        /* coin bar logic */\r\n        this.updateCoinBar(backCoins);\r\n   \r\n    }\r\n}\r\n\r\n"]}